#!/bin/bash
# Usage: wifi-connect <SSID> [password]
# Connects to WiFi network, reusing existing connection if available

set -euo pipefail

if [ $# -eq 0 ]; then
    echo "Usage: wifi-connect <SSID> [password]" >&2
    echo "Example: wifi-connect MyNetwork mypassword" >&2
    echo "For open networks: wifi-connect MyNetwork" >&2
    exit 1
fi

SSID="$1"
PASSWORD="${2:-}"

# Trigger WiFi rescan to ensure network is available
echo "Scanning for networks..."
nmcli dev wifi list --rescan yes > /dev/null  # Synchronous rescan

# Check if connection profile exists
if nmcli connection show "$SSID" &> /dev/null; then
    echo "Connection profile exists, bringing up: $SSID"
    nmcli connection up "$SSID"
else
    echo "Creating new connection: $SSID"
    if [ -z "$PASSWORD" ]; then
        # Try connecting to open network
        nmcli device wifi connect "$SSID"
    else
        # Connect with password
        nmcli device wifi connect "$SSID" password "$PASSWORD"
    fi
fi
