#!/usr/bin/env bash

# Logging setup
LOGFILE="/tmp/xinitrc.log"
echo "$(date): Starting xinitrc" > "$LOGFILE"

# X11 setup
xset s blank
xset s 600
xset dpms 1200 1800 2400
xsetroot -solid black
[ -f ~/.zshrc ] && . ~/.zshrc
[ -f ~/.xprofile ] && . ~/.xprofile
[ -e ~/.Xmodmap ] && xmodmap ~/.Xmodmap

# Background services
echo "$(date): Starting background services" >> "$LOGFILE"
xscreensaver -nosplash &
tmux new -A -s work &
redshift-palo-alto &

# Display setup
echo "$(date): Setting up display" >> "$LOGFILE"
xrandr --dpi 96
autorandr --change --default standalone

# Log keyboard state before explicit setup
echo "$(date): Keyboard state before explicit setup:" >> "$LOGFILE"
setxkbmap -query >> "$LOGFILE" 2>&1

# Explicitly set keyboard layout to ensure it sticks
echo "$(date): Setting keyboard layout explicitly" >> "$LOGFILE"
setxkbmap -layout us -variant dvorak -option caps:ctrl_modifier,compose:menu >> "$LOGFILE" 2>&1

# Log keyboard state after explicit setup
echo "$(date): Keyboard state after explicit setup:" >> "$LOGFILE"
setxkbmap -query >> "$LOGFILE" 2>&1

# Start i3
echo "$(date): Starting i3" >> "$LOGFILE"
exec i3 2>&1 | tee -a "$LOGFILE"
