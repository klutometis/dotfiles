#!/usr/bin/env bash

# X11 session initialization
#
# NOTE: Keyboard configuration moved to ~/.xprofile as a workaround.
# The X11 InputClass approach in 99-keyboard-happy-hacking.conf was
# working initially but getting overridden by something in the stack.

# Logging setup
LOGFILE="/tmp/xinitrc.log"
echo "$(date): Starting xinitrc" > "$LOGFILE"

# X11 setup
xset s blank
xset s 600
xset dpms 1200 1800 2400
xsetroot -solid black
[ -f ~/.zshrc ] && . ~/.zshrc
[ -f ~/.xprofile ] && . ~/.xprofile

# Background services
echo "$(date): Starting background services" >> "$LOGFILE"
xscreensaver -nosplash &
redshift-palo-alto &
sxhkd &

# Display setup
echo "$(date): Setting up display" >> "$LOGFILE"
xrandr --dpi 96
autorandr --change --default standalone

# Log keyboard state after setup
echo "$(date): Final keyboard state:" >> "$LOGFILE"
setxkbmap -query >> "$LOGFILE" 2>&1

# Start applications
echo "$(date): Starting applications" >> "$LOGFILE"
google-chrome --profile-directory=work-profile --window-name=chrome-work &
google-chrome --profile-directory=personal-profile --window-name=chrome-personal &
alacritty --title 'terminal' -e tmux new -A -s work &

# Start i3
echo "$(date): Starting i3" >> "$LOGFILE"
exec i3 2>&1 | tee -a "$LOGFILE"
